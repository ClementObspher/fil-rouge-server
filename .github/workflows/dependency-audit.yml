name: Audit de S√©curit√© des D√©pendances

on:
    schedule:
        # Ex√©cution hebdomadaire le lundi √† 9h
        - cron: "0 9 * * 1"
    workflow_dispatch:
        # Permet l'ex√©cution manuelle
    push:
        # D√©clench√© sur modification de package.json
        paths:
            - "package.json"
            - "bun.lock"

jobs:
    security-audit:
        runs-on: ubuntu-latest
        permissions:
            issues: write
            contents: read
            pull-requests: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install

            - name: Run security audit
              run: |
                  chmod +x scripts/security-audit.sh
                  ./scripts/security-audit.sh

            - name: Upload audit report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: security-audit-report
                  path: audit-report.md
                  retention-days: 30

            - name: Check for critical vulnerabilities
              run: |
                  if grep -q "Vuln√©rabilit√©s critiques d√©tect√©es" audit-report.md; then
                    echo "‚ùå Vuln√©rabilit√©s critiques d√©tect√©es!"
                    exit 1
                  else
                    echo "‚úÖ Aucune vuln√©rabilit√© critique"
                  fi

            - name: Create issue for outdated dependencies
              if: failure()
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const report = fs.readFileSync('audit-report.md', 'utf8');

                      const issueTitle = 'üîç Audit de S√©curit√© - Action Requise';
                      const issueBody = `
                      ## Audit de S√©curit√© Automatique

                      Un audit de s√©curit√© a d√©tect√© des probl√®mes n√©cessitant votre attention.

                      ### Rapport Complet
                      \`\`\`
                      ${report}
                      \`\`\`

                      ### Actions Requises
                      1. R√©viser les vuln√©rabilit√©s d√©tect√©es
                      2. Mettre √† jour les d√©pendances obsol√®tes
                      3. Tester l'application apr√®s les mises √† jour

                      ---
                      *G√©n√©r√© automatiquement par le workflow d'audit de s√©curit√©*
                      `;

                      await github.rest.issues.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: issueTitle,
                        body: issueBody,
                        labels: ['security', 'dependencies', 'automated']
                      });

    dependency-update:
        runs-on: ubuntu-latest
        needs: security-audit
        if: needs.security-audit.result == 'success'
        permissions:
            issues: write
            contents: write
            pull-requests: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Check for outdated dependencies
              run: |
                  bun outdated > outdated.txt || true
                  if [ -s outdated.txt ]; then
                    echo "D√©pendances obsol√®tes d√©tect√©es:"
                    cat outdated.txt
                    echo "::set-output name=has-updates::true"
                  else
                    echo "Toutes les d√©pendances sont √† jour"
                    echo "::set-output name=has-updates::false"
                  fi
              id: check-updates

            - name: Create Pull Request for updates
              if: steps.check-updates.outputs.has-updates == 'true'
              uses: peter-evans/create-pull-request@v5
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: "chore: Mise √† jour automatique des d√©pendances"
                  title: "üîÑ Mise √† jour automatique des d√©pendances"
                  body: |
                      ## Mise √† Jour Automatique des D√©pendances

                      Ce PR contient les mises √† jour automatiques des d√©pendances d√©tect√©es par l'audit de s√©curit√©.

                      ### D√©pendances Mises √† Jour
                      ```
                      $(cat outdated.txt)
                      ```

                      ### Actions Requises
                      - [ ] R√©viser les changements
                      - [ ] Tester l'application
                      - [ ] V√©rifier la compatibilit√©

                      ---
                      *G√©n√©r√© automatiquement par le workflow de mise √† jour*
                  branch: dependency-updates
                  delete-branch: true
