<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Monitoring - Fil Rouge Server</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #fff;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00ff87, #60efff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2d2d2d;
            padding: 15px 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-healthy {
            background: #4ade80;
        }

        .status-degraded {
            background: #fbbf24;
        }

        .status-unhealthy {
            background: #f87171;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #60efff;
        }

        .metric-title {
            font-size: 0.9rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-unit {
            font-size: 0.8rem;
            color: #888;
        }

        .services-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .service-card {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
        }

        .service-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .service-name {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .service-details {
            font-size: 0.9rem;
            color: #ccc;
        }

        .alerts-section {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background: rgba(248, 113, 113, 0.1);
            border-left: 3px solid #f87171;
        }

        .alert-critical {
            border-left-color: #f87171;
            background: rgba(248, 113, 113, 0.1);
        }

        .alert-warning {
            border-left-color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        .alert-info {
            border-left-color: #60efff;
            background: rgba(96, 239, 255, 0.1);
        }

        .alert-icon {
            font-size: 1.2rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-message {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .alert-details {
            font-size: 0.8rem;
            color: #888;
        }

        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #60efff;
            color: #1a1a1a;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #00ff87;
            transform: translateY(-2px);
        }

        .last-update {
            text-align: center;
            color: #888;
            font-size: 0.8rem;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #888;
        }

        .error {
            background: #dc2626;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üîç Dashboard Monitoring</h1>
            <p>Surveillance en temps r√©el - Fil Rouge Server</p>
        </div>

        <div id="error-message" class="error" style="display: none;"></div>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="overall-status"></div>
                <span id="overall-status-text">Chargement...</span>
            </div>
            <div>
                <span>Uptime: <span id="uptime">--</span></span>
            </div>
            <div>
                <span>Version: <span id="version">--</span></span>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-title">Temps de R√©ponse Moyen</div>
                <div class="metric-value" id="response-time">--</div>
                <div class="metric-unit">ms</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Utilisation M√©moire</div>
                <div class="metric-value" id="memory-usage">--</div>
                <div class="metric-unit">%</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Requ√™tes Totales</div>
                <div class="metric-value" id="total-requests">--</div>
                <div class="metric-unit">req</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Taux d'Erreur</div>
                <div class="metric-value" id="error-rate">--</div>
                <div class="metric-unit">%</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Connexions DB</div>
                <div class="metric-value" id="db-connections">--</div>
                <div class="metric-unit">active</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Requ√™tes/Sec</div>
                <div class="metric-value" id="rps">--</div>
                <div class="metric-unit">req/s</div>
            </div>
        </div>

        <div class="services-section">
            <div class="service-card">
                <div class="service-header">
                    <div class="service-name">üóÑÔ∏è Base de Donn√©es</div>
                    <div class="status-indicator">
                        <div class="status-dot" id="db-status"></div>
                        <span id="db-status-text">--</span>
                    </div>
                </div>
                <div class="service-details" id="db-details">
                    Chargement des d√©tails...
                </div>
            </div>

            <div class="service-card">
                <div class="service-header">
                    <div class="service-name">üì¶ Stockage MinIO</div>
                    <div class="status-indicator">
                        <div class="status-dot" id="storage-status"></div>
                        <span id="storage-status-text">--</span>
                    </div>
                </div>
                <div class="service-details" id="storage-details">
                    Chargement des d√©tails...
                </div>
            </div>

            <div class="service-card">
                <div class="service-header">
                    <div class="service-name">‚ö° Application</div>
                    <div class="status-indicator">
                        <div class="status-dot" id="app-status"></div>
                        <span id="app-status-text">--</span>
                    </div>
                </div>
                <div class="service-details" id="app-details">
                    Chargement des d√©tails...
                </div>
            </div>
        </div>

        <div class="alerts-section">
            <h3 style="margin-bottom: 20px;">üö® Alertes Actives</h3>
            <div id="alerts-container">
                <div class="loading">Chargement des alertes...</div>
            </div>
        </div>

        <button class="refresh-btn" onclick="refreshData()">üîÑ Actualiser</button>

        <div class="last-update">
            Derni√®re mise √† jour: <span id="last-update">--</span>
        </div>
    </div>

    <script>
        let refreshInterval;

        async function fetchData() {
            try {
                const [healthResponse, alertsResponse] = await Promise.all([
                    fetch('/monitoring/health'),
                    fetch('/monitoring/alerts')
                ]);

                const healthData = await healthResponse.json();
                const alertsData = await alertsResponse.json();

                updateHealthStatus(healthData);
                updateAlerts(alertsData);
                hideError();
            } catch (error) {
                showError('Erreur de connexion au syst√®me de monitoring: ' + error.message);
            }
        }

        function updateHealthStatus(data) {
            // Status global
            const statusDot = document.getElementById('overall-status');
            const statusText = document.getElementById('overall-status-text');

            statusDot.className = 'status-dot status-' + data.status;
            statusText.textContent = {
                'healthy': 'Syst√®me Op√©rationnel',
                'degraded': 'Performance D√©grad√©e',
                'unhealthy': 'Probl√®me Critique'
            }[data.status];

            // M√©triques g√©n√©rales
            document.getElementById('uptime').textContent = formatUptime(data.metrics.uptime);
            document.getElementById('version').textContent = data.version;
            document.getElementById('response-time').textContent = data.metrics.responseTime;
            document.getElementById('memory-usage').textContent = data.metrics.memoryUsage.percentage.toFixed(1);
            document.getElementById('total-requests').textContent = data.metrics.requests.total;
            document.getElementById('error-rate').textContent =
                data.metrics.requests.total > 0
                    ? ((data.metrics.requests.errors / data.metrics.requests.total) * 100).toFixed(1)
                    : '0.0';
            document.getElementById('db-connections').textContent = data.metrics.connections.database;
            document.getElementById('rps').textContent = data.metrics.requests.rps;

            // Services
            updateServiceStatus('db', data.services.database);
            updateServiceStatus('storage', data.services.storage);
            updateServiceStatus('app', data.services.application);
        }

        function updateServiceStatus(serviceId, serviceData) {
            const statusDot = document.getElementById(serviceId + '-status');
            const statusText = document.getElementById(serviceId + '-status-text');
            const details = document.getElementById(serviceId + '-details');

            statusDot.className = 'status-dot status-' + serviceData.status;
            statusText.textContent = {
                'healthy': 'Op√©rationnel',
                'degraded': 'D√©grad√©',
                'unhealthy': 'Indisponible'
            }[serviceData.status];

            if (serviceData.details) {
                const detailsText = Object.entries(serviceData.details)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join(' ‚Ä¢ ');
                details.textContent = detailsText;
            }

            if (serviceData.responseTime) {
                details.textContent += ` ‚Ä¢ Temps de r√©ponse: ${serviceData.responseTime}ms`;
            }
        }

        function updateAlerts(data) {
            const container = document.getElementById('alerts-container');

            if (data.alerts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #4ade80;">‚úÖ Aucune alerte active</div>';
                return;
            }

            container.innerHTML = data.alerts.map(alert => `
                <div class="alert-item alert-${alert.type}">
                    <div class="alert-icon">
                        ${alert.type === 'critical' ? 'üî¥' : alert.type === 'warning' ? 'üü†' : 'üü°'}
                    </div>
                    <div class="alert-content">
                        <div class="alert-message">${alert.message}</div>
                        <div class="alert-details">
                            ${alert.service} ‚Ä¢ ${alert.metric} ‚Ä¢ 
                            Seuil: ${alert.threshold} ‚Ä¢ Actuel: ${alert.currentValue.toFixed(1)} ‚Ä¢
                            ${new Date(alert.timestamp).toLocaleTimeString()}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            if (days > 0) return `${days}j ${hours}h ${minutes}m`;
            if (hours > 0) return `${hours}h ${minutes}m ${secs}s`;
            if (minutes > 0) return `${minutes}m ${secs}s`;
            return `${secs}s`;
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }

        function refreshData() {
            fetchData();
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function () {
            refreshData();

            // Actualisation automatique toutes les 10 secondes
            refreshInterval = setInterval(refreshData, 10000);
        });

        // Nettoyage √† la fermeture
        window.addEventListener('beforeunload', function () {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>

</html>